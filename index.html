<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Raees Pharmacy – Inventory & Expiration Tracker</title>

<style>
  :root{
    --bg:#0b1220; --card:#101a31; --text:#e9eefc; --muted:#aab6da; --line:#223055;
    --ok:#4ade80; --warn:#fbbf24; --bad:#fb7185; --btn:#3b82f6; --btn2:#22c55e; --btn3:#ef4444;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(160deg,#070b14,#0b1220 55%,#0e1730);color:var(--text);}
  header{max-width:1200px;margin:0 auto;padding:18px 16px 6px;}
  h1{margin:0 0 6px;font-size:22px}
  .sub{color:var(--muted);font-size:13px;line-height:1.4}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px 28px;}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
  @media(max-width:950px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(16,26,49,.92);border:1px solid rgba(34,48,85,.7);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,select,textarea{width:100%;box-sizing:border-box;background:#0b1326;border:1px solid rgba(34,48,85,.9);color:var(--text);border-radius:10px;padding:10px;font-size:14px;outline:none}
  textarea{min-height:70px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media(max-width:560px){.row,.row3{grid-template-columns:1fr}}
  .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;align-items:center}
  button{border:none;border-radius:12px;padding:10px 12px;font-weight:750;font-size:14px;cursor:pointer}
  .primary{background:var(--btn);color:white}
  .success{background:var(--btn2);color:#05210e}
  .danger{background:var(--btn3);color:white}
  .ghost{background:transparent;border:1px solid rgba(34,48,85,.9);color:var(--text)}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:end;justify-content:space-between;margin-bottom:10px}
  .pill{padding:5px 10px;border-radius:999px;font-size:12px;border:1px solid rgba(34,48,85,.9);color:var(--muted)}
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  th,td{padding:10px 8px;text-align:left;border-bottom:1px solid rgba(34,48,85,.65);font-size:13px;vertical-align:top}
  th{color:#cfe0ff;font-size:12px;letter-spacing:.02em;text-transform:uppercase}
  tr:hover td{background:rgba(11,19,38,.55)}
  .status{font-weight:900}
  .s-ok{color:var(--ok)} .s-warn{color:var(--warn)} .s-bad{color:var(--bad)}
  .small{color:var(--muted);font-size:12px}
  .nowrap{white-space:nowrap}
  .actions button{padding:7px 10px;border-radius:10px;font-size:12px}

  /* Scanner modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal.open{display:flex}
  .modal-card{width:min(760px,100%);background:#0b1326;border:1px solid rgba(34,48,85,.9);border-radius:14px;overflow:hidden}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(34,48,85,.65)}
  .modal-title{font-weight:900}
  #scanVideo{width:100%;height:auto;display:block;background:#000}
  .hint{padding:10px 12px;color:var(--muted);font-size:12px;line-height:1.4}
  .scan-line{position:absolute;left:8%;right:8%;top:45%;height:2px;background:rgba(251,191,36,.9);box-shadow:0 0 10px rgba(251,191,36,.8);}
  .videoWrap{position:relative}

  /* Print layout */
  @media print{
    body{background:#fff;color:#000}
    header,.no-print{display:none !important}
    .print-area{display:block !important}
    .print-area *{color:#000}
    .print-card{border:none;box-shadow:none;background:#fff}
    table{border:1px solid #000}
    th,td{border-bottom:1px solid #999}
  }
</style>
</head>

<body>
<header>
  <h1>Raees Pharmacy</h1>
  <div class="sub">
    Inventory • NDC • GS1 2D (DataMatrix) • Lot • Expiration • Audit Print • Monthly EXP PDF
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: Form + Reports -->
    <div class="card no-print">
      <div class="toolbar">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <span class="pill" id="countPill">0 items</span>
          <span class="pill" id="expSoonPill">0 exp soon</span>
          <span class="pill" id="expiredPill">0 expired</span>
        </div>
        <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
          <div>
            <div class="small">EXP warning (days)</div>
            <input id="warnDays" type="number" min="1" value="90" style="width:110px" />
          </div>
          <div>
            <div class="small">Default low stock</div>
            <input id="lowDefault" type="number" min="0" value="5" style="width:110px" />
          </div>
        </div>
      </div>

      <form id="medForm">
        <input type="hidden" id="editId" value="" />

        <label>Medication Name</label>
        <input id="name" placeholder="(Optional if GS1 scan fills NDC/lot/exp first)" />

        <div class="row">
          <div>
            <label>NDC (auto-filled from GS1 GTIN when possible)</label>
            <input id="ndc" placeholder="23155-704-01" />
          </div>
          <div>
            <label>Wholesaler / Vendor</label>
            <select id="vendor">
              <option value="">Select vendor</option>
              <option>Kinray</option>
              <option>Anda</option>
              <option>Alpine Health</option>
              <option>EzriRx</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Barcode / GS1 code (auto-filled)</label>
            <input id="barcode" placeholder="Scan 2D square code or 1D UPC" />
            <div class="btns" style="margin-top:8px">
              <button class="primary" type="button" id="scanBtn">Scan Bottle (GS1 2D + 1D)</button>
              <button class="ghost" type="button" id="clearScanBtn">Clear Scan</button>
            </div>
            <div class="small">
              Tip: scan the <strong>square 2D DataMatrix</strong> to auto-fill LOT + EXP.
              (Camera requires HTTPS — GitHub Pages is perfect.)
            </div>
          </div>
          <div>
            <label>GTIN (from AI 01, auto-filled)</label>
            <input id="gtin" placeholder="00323155704013" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Lot Number (AI 10, auto-filled)</label>
            <input id="lot" placeholder="Lot #" />
          </div>
          <div>
            <label>Expiration Date (AI 17, auto-filled)</label>
            <input id="exp" type="date" />
          </div>
          <div>
            <label>Quantity On Hand</label>
            <input id="qty" type="number" min="0" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Low Stock Alert</label>
            <input id="low" type="number" min="0" placeholder="e.g., 5" />
          </div>
          <div>
            <label>Location / Shelf / Fridge / CII safe</label>
            <input id="loc" placeholder="Fast mover / Refrigerator / C-II Safe" />
          </div>
        </div>

        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Invoice notes, package size, etc."></textarea>

        <div class="btns">
          <button class="success" type="submit" id="saveBtn">Save Item</button>
          <button class="ghost" type="button" id="resetBtn">Clear</button>
          <button class="ghost" type="button" id="exportBtn">Export CSV</button>
          <button class="danger" type="button" id="wipeBtn">Delete All</button>
        </div>
      </form>

      <hr style="border:0;border-top:1px solid rgba(34,48,85,.65);margin:14px 0">

      <h3 style="margin:0 0 10px">Monthly Expiration Report</h3>
      <div class="row">
        <div>
          <label>Month</label>
          <select id="reportMonth"></select>
        </div>
        <div>
          <label>Year</label>
          <select id="reportYear"></select>
        </div>
      </div>
      <div class="btns">
        <button class="primary" type="button" id="pdfBtn">Generate Monthly EXP PDF</button>
        <button class="ghost" type="button" id="auditPrintBtn">Audit-Ready Print</button>
      </div>
    </div>

    <!-- RIGHT: Inventory Table -->
    <div class="card no-print">
      <div class="toolbar">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <input id="search" placeholder="Search: name / NDC / GTIN / barcode / lot / vendor…" />
          <select id="filter">
            <option value="all">All</option>
            <option value="expSoon">Expiring soon</option>
            <option value="expired">Expired</option>
            <option value="lowStock">Low stock</option>
          </select>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="ghost" type="button" id="sortBtn">Sort: Exp</button>
        </div>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Drug</th>
              <th class="nowrap">Vendor</th>
              <th class="nowrap">NDC</th>
              <th class="nowrap">GTIN</th>
              <th class="nowrap">Lot</th>
              <th class="nowrap">Exp</th>
              <th class="nowrap">Qty</th>
              <th>Status</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="small" id="emptyMsg" style="margin-top:10px">No items yet — add your first product.</div>
    </div>

  </div>

  <!-- PRINT AREA -->
  <div class="print-area" style="display:none">
    <div class="card print-card">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
        <div>
          <div style="font-size:22px;font-weight:900">Raees Pharmacy</div>
          <div style="font-size:13px">Inventory / Expiration Audit Report</div>
          <div style="font-size:12px;margin-top:6px" id="printMeta"></div>
        </div>
        <div style="text-align:right;font-size:12px">
          <div><strong>Run Date:</strong> <span id="printRunDate"></span></div>
          <div><strong>Filter:</strong> <span id="printFilter"></span></div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #000;margin:10px 0">

      <table>
        <thead>
          <tr>
            <th>Medication</th>
            <th>Vendor</th>
            <th>NDC</th>
            <th>GTIN</th>
            <th>Lot</th>
            <th>Exp</th>
            <th>Qty</th>
            <th>Location</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="printTbody"></tbody>
      </table>

      <div style="margin-top:16px;font-size:12px">
        <div><strong>Reviewed by (Name):</strong> ________________________________</div>
        <div style="margin-top:8px"><strong>Signature:</strong> ________________________________  <strong>Date:</strong> ____________</div>
        <div style="margin-top:10px">Notes/Corrective Actions: ________________________________________________________________</div>
      </div>
    </div>
  </div>

</div>

<!-- GS1/2D + 1D Scanner (ZXing) -->
<script type="module">
  import { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";
  window.__ZXING__ = { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType };
</script>

<!-- jsPDF + autotable for PDF reports -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/*** Storage + helpers ***/
const KEY = "raees_pharmacy_inventory_v3";
const $ = (id)=>document.getElementById(id);
let sortMode = "exp"; // exp or name

function load(){ try { return JSON.parse(localStorage.getItem(KEY) || "[]"); } catch { return []; } }
function save(items){ localStorage.setItem(KEY, JSON.stringify(items)); }
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function todayISO(){
  const d=new Date(); d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function daysLeft(exp){
  if(!exp) return NaN;
  const t=new Date(todayISO()); t.setHours(0,0,0,0);
  const e=new Date(exp); e.setHours(0,0,0,0);
  return Math.round((e - t)/(1000*60*60*24));
}
function statusFor(item, warnDays){
  const d = daysLeft(item.exp);
  if (Number.isFinite(d) && d < 0) return {label:"EXPIRED", cls:"s-bad", d};
  if (Number.isFinite(d) && d <= warnDays) return {label:"EXP SOON", cls:"s-warn", d};
  return {label:"OK", cls:"s-ok", d};
}
function lowStock(item){
  const low = item.low === "" || item.low == null ? null : Number(item.low);
  if (low == null || !Number.isFinite(low)) return false;
  return Number(item.qty || 0) <= low;
}

/*** GS1 parsing (handles AI 01/10/17 + common cases) ***/
const GS = String.fromCharCode(29); // group separator
function normalizeScanText(text){
  if(!text) return "";
  // Remove symbology identifiers like ]d2 ]C1
  if(text.startsWith("]")) return text.slice(3);
  return text;
}
// Parse GS1 element strings for common AIs on drug bottles:
// (01) GTIN fixed 14
// (17) EXP fixed 6 (YYMMDD)
// (10) LOT variable up to 20 (terminated by GS or end)
// (21) SERIAL variable (optional)
function parseGS1(text){
  const raw = normalizeScanText(text);

  // Some decoders include GS as actual ASCII 29; others show it as \u001d already.
  // We handle both by keeping it as character.
  let s = raw;

  // If no parentheses AIs present, assume AI stream format.
  // We'll read sequential AIs by known patterns.
  const out = { raw: raw };

  function readFixed(ai, len){
    if(!s.startsWith(ai)) return null;
    const v = s.slice(ai.length, ai.length + len);
    s = s.slice(ai.length + len);
    return v;
  }
  function readVar(ai, maxLen){
    if(!s.startsWith(ai)) return null;
    s = s.slice(ai.length);
    let end = s.indexOf(GS);
    if(end === -1) end = s.length;
    const v = s.slice(0, Math.min(end, maxLen));
    s = s.slice(Math.min(end, maxLen));
    // consume GS if present
    if(s.startsWith(GS)) s = s.slice(1);
    return v;
  }

  // Try to extract in common order: 01, 17, 10, 21
  // But real-world may be 01 + 10 + 17 etc, so loop.
  let safety = 0;
  while(s.length && safety++ < 50){
    if(s.startsWith("01")){
      out.gtin = readFixed("01", 14);
      continue;
    }
    if(s.startsWith("17")){
      out.expYYMMDD = readFixed("17", 6);
      continue;
    }
    if(s.startsWith("10")){
      out.lot = readVar("10", 20);
      continue;
    }
    if(s.startsWith("21")){
      out.serial = readVar("21", 20);
      continue;
    }
    // unknown AI -> break to avoid infinite loop
    break;
  }
  return out;
}

function yymmddToISODate(yymmdd){
  if(!yymmdd || yymmdd.length !== 6) return "";
  const yy = Number(yymmdd.slice(0,2));
  const mm = Number(yymmdd.slice(2,4));
  const dd = Number(yymmdd.slice(4,6));
  if(!Number.isFinite(yy)||!Number.isFinite(mm)||!Number.isFinite(dd)) return "";
  // GS1 uses 00-99; assume 20xx for 00-79, 19xx for 80-99 (rare). Adjust if needed.
  const year = (yy <= 79) ? (2000 + yy) : (1900 + yy);
  const iso = `${year}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
  return iso;
}
  /* ===== DS9208 / keyboard-wedge GS1 auto-parse ===== */

const barcodeInput = document.getElementById("barcode");

barcodeInput.addEventListener("input", () => {
  const value = barcodeInput.value;
  if (!value || value.length < 10) return;

  const gs1 = parseGS1(value);

  if (gs1.gtin) {
    document.getElementById("gtin").value = gs1.gtin;

    const ndc = gtinToNdc(gs1.gtin);
    if (ndc) document.getElementById("ndc").value = ndc;
  }

  if (gs1.lot) {
    document.getElementById("lot").value = gs1.lot;
  }

  if (gs1.expYYMMDD) {
    const iso = yymmddToISODate(gs1.expYYMMDD);
    if (iso) document.getElementById("exp").value = iso;
  }

  // Auto-set low stock if empty
  const lowField = document.getElementById("low");
  if (lowField && lowField.value === "") {
    lowField.value = document.getElementById("lowDefault").value;
  }
});


// Your bottle example: GTIN 00323155704013 maps to NDC 23155-704-01
function gtinToNdc(gtin14){
  const g = String(gtin14 || "").replace(/\D/g,"");
  if(g.length !== 14) return "";
  // Common pharma pattern: "003" + NDC10 + check digit (last digit)
  if(g.startsWith("003")){
    const ndc10 = g.slice(3, 13); // 10 digits
    // Format 5-3-2 (works for your example)
    return `${ndc10.slice(0,5)}-${ndc10.slice(5,8)}-${ndc10.slice(8,10)}`;
  }
  // Fallback: store raw 10 digits (strip leading 0 + check)
  // Not always correct for every manufacturer, but better than blank.
  const maybe = g.slice(1, 11);
  return maybe ? maybe : "";
}

/*** Render table ***/
function render(){
  const warnDays = Math.max(1, Number($("warnDays").value || 90));
  const q = $("search").value.trim().toLowerCase();
  const filter = $("filter").value;

  let items = load();

  // stats pills
  const expSoonCount = items.filter(x => statusFor(x, warnDays).label === "EXP SOON").length;
  const expiredCount = items.filter(x => statusFor(x, warnDays).label === "EXPIRED").length;
  $("countPill").textContent = `${items.length} items`;
  $("expSoonPill").textContent = `${expSoonCount} exp soon`;
  $("expiredPill").textContent = `${expiredCount} expired`;

  // sort
  items.sort((a,b)=>{
    if(sortMode==="name") return (a.name||"").localeCompare(b.name||"");
    return (a.exp||"").localeCompare(b.exp||"");
  });

  // filter + search
  items = items.filter(x=>{
    const hay = `${x.name} ${x.vendor} ${x.ndc} ${x.gtin} ${x.barcode} ${x.lot} ${x.loc} ${x.notes}`.toLowerCase();
    if(q && !hay.includes(q)) return false;

    const st = statusFor(x, warnDays);
    if(filter==="expired") return st.label==="EXPIRED";
    if(filter==="expSoon") return st.label==="EXP SOON";
    if(filter==="lowStock") return lowStock(x);
    return true;
  });

  const tb = $("tbody");
  tb.innerHTML = "";
  $("emptyMsg").style.display = load().length === 0 ? "block" : "none";

  for(const item of items){
    const st = statusFor(item, warnDays);
    const low = lowStock(item);
    const lowTag = low ? " / LOW" : "";
    const dTxt = Number.isFinite(st.d) ? (st.d<0 ? `${Math.abs(st.d)} days ago` : `${st.d} days left`) : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div><strong>${esc(item.name||"")}</strong></div>
        <div class="small">${esc(item.loc||"")}</div>
      </td>
      <td class="nowrap">${esc(item.vendor||"")}</td>
      <td class="nowrap">${esc(item.ndc||"")}</td>
      <td class="nowrap">${esc(item.gtin||"")}</td>
      <td class="nowrap">${esc(item.lot||"")}</td>
      <td class="nowrap">${esc(item.exp||"")}<div class="small">${esc(dTxt)}</div></td>
      <td class="nowrap"><strong>${Number(item.qty||0)}</strong></td>
      <td class="status ${st.cls}">${st.label}${lowTag}</td>
      <td class="actions nowrap">
        <button class="ghost" onclick="editItem('${item.id}')">Edit</button>
        <button class="ghost" onclick="useOne('${item.id}')">-1</button>
        <button class="danger" onclick="deleteItem('${item.id}')">Delete</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

/*** CRUD ***/
function upsert(item){
  const items = load();
  const idx = items.findIndex(x=>x.id===item.id);
  if(idx>=0) items[idx]=item; else items.push(item);
  save(items);
}
function resetForm(){
  $("editId").value="";
  $("medForm").reset();
  $("saveBtn").textContent="Save Item";
  $("low").value="";
}
function editItem(id){
  const item = load().find(x=>x.id===id);
  if(!item) return;
  $("editId").value=item.id;
  $("name").value=item.name||"";
  $("vendor").value=item.vendor||"";
  $("ndc").value=item.ndc||"";
  $("gtin").value=item.gtin||"";
  $("barcode").value=item.barcode||"";
  $("lot").value=item.lot||"";
  $("exp").value=item.exp||"";
  $("qty").value=item.qty ?? "";
  $("low").value=item.low ?? "";
  $("loc").value=item.loc||"";
  $("notes").value=item.notes||"";
  $("saveBtn").textContent="Update Item";
  window.scrollTo({top:0,behavior:"smooth"});
}
function deleteItem(id){
  if(!confirm("Delete this item?")) return;
  save(load().filter(x=>x.id!==id));
  render();
}
function useOne(id){
  const items = load();
  const i = items.findIndex(x=>x.id===id);
  if(i<0) return;
  items[i].qty = Math.max(0, Number(items[i].qty||0) - 1);
  save(items);
  render();
}

/*** CSV Export ***/
function exportCSV(){
  const items=load();
  const cols=["name","vendor","ndc","gtin","barcode","lot","exp","qty","low","loc","notes"];
  const header=cols.join(",");
  const lines=items.map(it => cols.map(c => csvCell(it[c])).join(","));
  const csv=[header, ...lines].join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="Raees_Pharmacy_Inventory.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function csvCell(v){
  const s=String(v ?? "");
  if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}

/*** Scanner modal (ZXing) ***/
const modal = document.createElement("div");
modal.className="modal";
modal.innerHTML = `
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">Scan Bottle (GS1 2D + 1D)</div>
      <button class="ghost" id="closeScan">Close</button>
    </div>
    <div class="videoWrap">
      <video id="scanVideo" muted playsinline></video>
      <div class="scan-line"></div>
    </div>
    <div class="hint">
      Scan the <strong>square 2D DataMatrix</strong> to fill <strong>GTIN/NDC + LOT + EXP</strong> automatically.
      Good light + steady hands helps.
    </div>
  </div>
`;
document.body.appendChild(modal);

let codeReader = null;
let scanStream = null;
let scanning = false;

async function startScanner(){
  modal.classList.add("open");

  // Wait until ZXing module is loaded
  const waitZX = () => new Promise(r=>{
    const t=setInterval(()=>{
      if(window.__ZXING__){clearInterval(t); r();}
    },50);
  });
  await waitZX();

  if(scanning) return;
  scanning = true;

  const { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } = window.__ZXING__;
  const hints = new Map();
  hints.set(DecodeHintType.POSSIBLE_FORMATS, [
    BarcodeFormat.DATA_MATRIX,   // GS1 2D
    BarcodeFormat.QR_CODE,       // sometimes used
    BarcodeFormat.CODE_128,
    BarcodeFormat.CODE_39,
    BarcodeFormat.EAN_13,
    BarcodeFormat.EAN_8,
    BarcodeFormat.UPC_A,
    BarcodeFormat.UPC_E,
    BarcodeFormat.ITF
  ]);

  codeReader = new BrowserMultiFormatReader(hints, { delayBetweenScanAttempts: 150 });

  const video = document.getElementById("scanVideo");

  try{
    const constraints = { video: { facingMode: { ideal: "environment" } } };
    scanStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = scanStream;
    await video.play();

    // Decode continuously from video element
    const result = await codeReader.decodeOnceFromVideoElement(video);
    const text = result?.getText?.() || "";

    stopScanner();

    // Auto-populate fields
    handleScannedText(text);

  } catch(err){
    stopScanner();
    alert(
      "Scanner error: " + (err?.message || err) +
      "\n\nIf camera won’t open: make sure you are using HTTPS (GitHub Pages link) and allow camera permission."
    );
  }
}

function stopScanner(){
  modal.classList.remove("open");
  scanning = false;

  try{ codeReader?.reset?.(); } catch(e){}
  codeReader = null;

  if(scanStream){
    try{ scanStream.getTracks().forEach(t=>t.stop()); }catch(e){}
    scanStream = null;
  }
}

function handleScannedText(text){
  const raw = text || "";
  $("barcode").value = raw;

  const gs1 = parseGS1(raw);

  if(gs1.gtin){
    $("gtin").value = gs1.gtin;
    const ndcGuess = gtinToNdc(gs1.gtin);
    if(ndcGuess && !$("ndc").value) $("ndc").value = ndcGuess;
    if(ndcGuess) $("ndc").value = ndcGuess; // overwrite with best guess
  }

  if(gs1.lot){
    $("lot").value = gs1.lot;
  }

  if(gs1.expYYMMDD){
    const iso = yymmddToISODate(gs1.expYYMMDD);
    if(iso) $("exp").value = iso;
  }

  // Nice UX: if low stock is blank, set default
  if($("low").value === "") $("low").value = $("lowDefault").value;

  // If med name blank, leave it blank (you can add later or we can integrate NDC->name lookup next)
}

document.addEventListener("click",(e)=>{
  if(e.target?.id==="scanBtn") startScanner();
  if(e.target?.id==="closeScan") stopScanner();
});

function clearScan(){
  $("barcode").value="";
  $("gtin").value="";
  $("ndc").value="";
  $("lot").value="";
  $("exp").value="";
}
$("clearScanBtn").addEventListener("click", clearScan);

/*** Monthly PDF report ***/
function fillMonthYear(){
  const m = $("reportMonth"), y = $("reportYear");
  const now = new Date();
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  monthNames.forEach((name, idx)=>{
    const opt=document.createElement("option");
    opt.value=idx; opt.textContent=name;
    m.appendChild(opt);
  });
  m.value = now.getMonth();

  const thisYear = now.getFullYear();
  for(let yy=thisYear-2; yy<=thisYear+2; yy++){
    const opt=document.createElement("option");
    opt.value=yy; opt.textContent=yy;
    y.appendChild(opt);
  }
  y.value = thisYear;
}

function generateMonthlyPDF(){
  const month = Number($("reportMonth").value);
  const year = Number($("reportYear").value);

  const items = load().filter(it=>{
    if(!it.exp) return false;
    const d = new Date(it.exp);
    return d.getFullYear()===year && d.getMonth()===month;
  }).sort((a,b)=>(a.exp||"").localeCompare(b.exp||""));

  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"pt", format:"letter"});

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Raees Pharmacy", 40, 40);
  doc.setFontSize(12);
  doc.text("Monthly Expiration Report", 40, 60);
  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`Month: ${monthNames[month]} ${year}`, 40, 78);
  doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 92);

  const rows = items.map(it => ([
    it.name || "",
    it.vendor || "",
    it.ndc || "",
    it.gtin || "",
    it.lot || "",
    it.exp || "",
    String(Number(it.qty||0)),
    it.loc || ""
  ]));

  doc.autoTable({
    startY: 110,
    head: [["Medication","Vendor","NDC","GTIN","Lot","Exp","Qty","Location"]],
    body: rows.length ? rows : [["(No items expiring this month)","","","","","","",""]],
    styles: { fontSize: 8, cellPadding: 4 },
    headStyles: { fillColor: [20, 30, 60] }
  });

  const endY = doc.lastAutoTable.finalY + 20;
  doc.setFontSize(10);
  doc.text("Reviewed by (Name): ________________________________", 40, endY);
  doc.text("Signature: __________________________  Date: ____________", 40, endY + 16);

  const fname = `Raees_Pharmacy_Expiration_Report_${year}_${String(month+1).padStart(2,"0")}.pdf`;
  doc.save(fname);
}

/*** Audit print ***/
function buildAuditPrint(){
  const warnDays = Math.max(1, Number($("warnDays").value || 90));
  const q = $("search").value.trim().toLowerCase();
  const filter = $("filter").value;

  let items = load();
  items = items.filter(x=>{
    const hay = `${x.name} ${x.vendor} ${x.ndc} ${x.gtin} ${x.barcode} ${x.lot} ${x.loc} ${x.notes}`.toLowerCase();
    if(q && !hay.includes(q)) return false;
    const st = statusFor(x, warnDays);
    if(filter==="expired") return st.label==="EXPIRED";
    if(filter==="expSoon") return st.label==="EXP SOON";
    if(filter==="lowStock") return lowStock(x);
    return true;
  }).sort((a,b)=>(a.exp||"").localeCompare(b.exp||""));

  $("printRunDate").textContent = new Date().toLocaleString();
  $("printFilter").textContent = filter + (q ? ` + search("${q}")` : "");
  $("printMeta").textContent = `Includes Vendor + NDC/GTIN + Lot/Exp + Qty/Location. Warning window: ${warnDays} days.`;

  const ptb = $("printTbody");
  ptb.innerHTML = "";

  for(const it of items){
    const st = statusFor(it, warnDays);
    const low = lowStock(it);
    const lowTag = low ? " / LOW" : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(it.name||"")}</td>
      <td>${esc(it.vendor||"")}</td>
      <td>${esc(it.ndc||"")}</td>
      <td>${esc(it.gtin||"")}</td>
      <td>${esc(it.lot||"")}</td>
      <td>${esc(it.exp||"")}</td>
      <td>${Number(it.qty||0)}</td>
      <td>${esc(it.loc||"")}</td>
      <td>${esc(st.label + lowTag)}</td>
    `;
    ptb.appendChild(tr);
  }
  if(!items.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="9">(No items match current filter/search)</td>`;
    ptb.appendChild(tr);
  }

  document.querySelector(".print-area").style.display="block";
  window.print();
  setTimeout(()=>{ document.querySelector(".print-area").style.display="none"; }, 500);
}

/*** Events ***/
$("medForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const id = $("editId").value || `m_${Date.now()}`;
  const lowVal = $("low").value === "" ? $("lowDefault").value : $("low").value;

  const item = {
    id,
    name: $("name").value.trim(),
    vendor: $("vendor").value,
    ndc: $("ndc").value.trim(),
    gtin: $("gtin").value.trim(),
    barcode: $("barcode").value.trim(),
    lot: $("lot").value.trim(),
    exp: $("exp").value,
    qty: Number($("qty").value || 0),
    low: lowVal === "" ? "" : Number(lowVal),
    loc: $("loc").value.trim(),
    notes: $("notes").value.trim()
  };

  if(!item.exp) return alert("Expiration date is required (scan GS1 2D or type it).");
  if(!Number.isFinite(item.qty)) return alert("Quantity is required.");
  upsert(item);
  resetForm();
  render();
});

$("resetBtn").addEventListener("click", resetForm);
$("exportBtn").addEventListener("click", exportCSV);

$("wipeBtn").addEventListener("click", ()=>{
  if(!confirm("Delete ALL saved inventory from this device?")) return;
  localStorage.removeItem(KEY);
  resetForm();
  render();
});

$("search").addEventListener("input", render);
$("filter").addEventListener("change", render);
$("warnDays").addEventListener("input", render);

$("sortBtn").addEventListener("click", ()=>{
  sortMode = (sortMode==="exp") ? "name" : "exp";
  $("sortBtn").textContent = sortMode==="exp" ? "Sort: Exp" : "Sort: Name";
  render();
});

$("pdfBtn").addEventListener("click", generateMonthlyPDF);
$("auditPrintBtn").addEventListener("click", buildAuditPrint);

/*** init ***/
fillMonthYear();
render();
</script>

</body>
</html>
